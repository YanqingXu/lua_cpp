---
description: 识别当前功能规格中未充分指定的区域，通过最多5个高度针对性的澄清问题来减少歧义
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

用户输入可以直接由代理提供或作为命令参数 - 在继续提示之前**必须**考虑它（如果不为空）。

用户输入:

$ARGUMENTS

目标：检测并减少活动功能规格中的歧义或缺失决策点，并将澄清结果直接记录在规格文件中。

注意：此澄清工作流程预期在调用 `/plan` 之前运行（并完成）。如果用户明确表示他们正在跳过澄清（例如，探索性原型），您可以继续，但必须警告下游返工风险增加。

执行步骤：

1. 从repo根目录运行 `{SCRIPT}` **一次**（组合 `--json --paths-only` 模式）。解析最小JSON负载字段：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - 如果JSON解析失败，中止并指示用户重新运行 `/specify` 或验证功能分支环境。

2. 加载当前规格文件。使用此分类法执行结构化歧义和覆盖扫描。对于每个类别，标记状态：Clear / Partial / Missing。生成用于优先级排序的内部覆盖图（除非不会提出问题，否则不输出原始图）。

   **功能范围和行为**：
   - Lua 5.1.5语法特性完整性（关键字、运算符、控制流）
   - 标准库实现范围和兼容性要求
   - C API接口完整性和二进制兼容性
   - 错误处理和边界条件行为

   **域和数据模型**：
   - 核心Lua数据类型（Value, Table, Function, String等）
   - 虚拟机状态管理和生命周期
   - 内存管理策略和垃圾回收
   - 字节码格式和指令集

   **架构和实现**：
   - 模块化设计和组件依赖关系
   - 现代C++特性使用策略（智能指针、RAII、模板）
   - 性能优化目标和基准
   - 与参考项目（lua_c_analysis、lua_with_cpp）集成策略

   **质量和测试**：
   - 测试覆盖率要求和测试策略
   - 性能基准和回归测试
   - 兼容性验证方法
   - 代码质量标准和静态分析

   **集成和部署**：
   - 构建系统要求（CMake配置）
   - 平台支持范围（Windows、Linux、macOS）
   - 依赖管理和第三方库策略
   - 包装和分发策略

3. 生成（内部）优先级澄清问题队列（最多5个）。不要一次输出所有问题。应用这些约束：
    - 整个会话总共最多5个问题。
    - 每个问题都必须可以用以下任一方式回答：
       * 简短的多项选择（2-5个不同的、互斥的选项），或
       * 一个单词/短语答案（明确约束："用≤5个单词回答"）。
   - 只包括其答案会实质性影响架构、数据建模、任务分解、测试设计、UX行为、运营准备或合规验证的问题。

4. 顺序提问循环（交互式）：
    - 一次只提出**一个**问题。
    - 对于多项选择问题，将选项呈现为Markdown表格。
    - 用户回答后验证答案并记录在工作内存中。
    - 完成所有关键歧义解决后停止提问。

5. 每个接受答案后的集成（增量更新方法）：
    - 如果不存在，确保存在 `## 澄清` 部分。
    - 追加项目符号线：`- Q: <问题> → A: <最终答案>`。
    - 然后立即将澄清应用到最适当的部分。

6. 验证和完成报告。

行为规则：
- 如果没有发现有意义的歧义，响应："未检测到值得正式澄清的关键歧义。"并建议继续。
- 如果规格文件缺失，指示用户首先运行 `/specify`。
- 永远不要超过总共5个问题。
- 尊重用户的提前终止信号。

上下文优先级：{ARGS}