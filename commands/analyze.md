---
description: 在任务生成后对spec.md、plan.md和tasks.md进行非破坏性跨文档一致性和质量分析
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

用户输入可以直接由代理提供或作为命令参数 - 在继续提示之前**必须**考虑它（如果不为空）。

用户输入:

$ARGUMENTS

目标：在实施前识别三个核心文档（`spec.md`、`plan.md`、`tasks.md`）中的不一致性、重复、歧义和未充分指定的项目。此命令**必须**仅在 `/tasks` 成功生成完整的 `tasks.md` 后运行。

严格只读：**不要**修改任何文件。输出结构化分析报告。提供可选的修复计划（用户必须明确批准，然后手动调用任何后续编辑命令）。

宪法权威：项目宪法（`/memory/constitution.md`）在此分析范围内是**不可协商的**。宪法冲突自动为关键问题，需要调整规格、计划或任务——而不是削弱、重新解释或静默忽略原则。

执行步骤：

1. 从repo根目录运行 `{SCRIPT}` 一次，解析FEATURE_DIR和AVAILABLE_DOCS的JSON。导出绝对路径：
   - SPEC = FEATURE_DIR/spec.md
   - PLAN = FEATURE_DIR/plan.md  
   - TASKS = FEATURE_DIR/tasks.md
   如果任何必需文件缺失，中止并显示错误消息。

2. 加载文档：
   - 解析spec.md部分：概述/上下文、功能需求、非功能需求、用户故事、边界情况
   - 解析plan.md：架构/技术栈选择、数据模型引用、阶段、技术约束
   - 解析tasks.md：任务ID、描述、阶段分组、并行标记[P]、引用文件路径
   - 加载宪法 `/memory/constitution.md` 进行原则验证

3. 构建内部语义模型：
   - 需求清单：每个功能+非功能需求
   - 用户故事/操作清单
   - 任务覆盖映射：将每个任务映射到一个或多个需求或故事
   - 宪法规则集：提取原则名称和任何MUST/SHOULD规范性声明

4. 检测过程：
   A. 重复检测：识别近似重复的需求
   B. 歧义检测：标记模糊形容词和未解决的占位符
   C. 规格不足：缺少对象或可测量结果的需求
   D. 宪法对齐：任何与MUST原则冲突的需求或计划元素
   E. 覆盖差距：零相关任务的需求，无映射需求/故事的任务
   F. 不一致性：术语漂移、数据实体差异、任务排序矛盾

5. 严重性分配启发式：
   - 关键：违反宪法MUST、缺少核心规格或阻止基线功能的零覆盖需求
   - 高：重复或冲突需求、模糊安全/性能属性
   - 中等：术语漂移、缺少非功能任务覆盖
   - 低：样式/措辞改进、不影响执行的轻微冗余

6. 生成Markdown报告（无文件写入）：

   ### lua_cpp规格分析报告
   | ID | 类别 | 严重性 | 位置 | 摘要 | 建议 |
   |----|------|---------|------|------|------|
   | A1 | 重复 | 高 | spec.md:L120-134 | 两个相似需求... | 合并措辞；保留更清晰版本 |
   
   额外子部分：
   - 覆盖摘要表：需求键 | 有任务? | 任务ID | 注释
   - 宪法对齐问题（如有）
   - 未映射任务（如有）
   - 指标：总需求数、总任务数、覆盖百分比、歧义计数、重复计数、关键问题计数

7. 在报告末尾，输出简洁的下一步操作块：
   - 如果存在关键问题：建议在 `/implement` 前解决
   - 如果只有低/中等问题：用户可继续，但提供改进建议
   - 提供明确的命令建议

8. 询问用户："您希望我为前N个问题建议具体的修复编辑吗？"（不要自动应用）

行为规则：
- 从不修改文件
- 从不虚构缺失部分——如果不存在，报告它们
- 保持发现的确定性：如果无变化重新运行，产生一致的ID和计数
- 将主表中的总发现限制为50；在摘要溢出注释中汇总其余部分

上下文：{ARGS}