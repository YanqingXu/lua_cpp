<!--
Sync Impact Report - Constitution v1.1.0
- Version change: 1.0.0 → 1.1.0
- Modified principles: 
  * Enhanced versioning and metadata structure
  * Improved formatting alignment with spec-kit templates
- Added sections: Metadata header, ISO date formatting
- Removed sections: None
- Templates requiring updates: ✅ All aligned
- Follow-up TODOs: None
-->

# 现代C++ Lua解释器项目宪法

**版本**: 1.1.0  
**制定日期**: 2025-09-20  
**最后修订**: 2025-09-20  
**状态**: 生效中  

## 核心原则

### 一. Lua 5.1.5 完全兼容性（不可协商）
**绝对兼容** Lua 5.1.5 的语法、语义和行为特性。
- 所有现有 Lua 5.1.5 脚本必须完全兼容运行
- 在可能的情况下保持字节码兼容性
- 保留 C 扩展的 API 兼容性
- 以参考实现的行为为准则
- 通过官方测试套件验证兼容性

### 二. 现代C++架构设计
**充分利用 C++17/20 特性** 构建安全、清晰、高性能的代码。
- 所有资源管理使用 RAII 原则
- 智能指针替代原始指针
- 通过强类型和模板确保类型安全
- 适当使用 constexpr 和编译时计算
- 禁止 C 风格转换和不安全操作
- 现代STL容器和算法优先

### 三. 性能优先设计
**在保持代码清晰的前提下优化执行速度**。
- 虚拟机指令分发优化
- 内存布局优化以提高缓存效率
- 垃圾回收性能调优
- 零成本抽象原则
- 基于基准测试的优化决策
- 性能回归测试保护

### 四. 模块化架构
**关注点清晰分离** 与定义良好的接口。
- 每个主要组件作为独立模块
- 清晰的依赖关系和接口定义
- 组件可独立测试
- 为扩展预留插件化架构
- 适当情况下使用仅头文件库
- 最小化模块间耦合

### 五. 测试驱动开发（强制性）
**全面测试策略** 确保系统可靠性。
- 所有组件的单元测试
- 虚拟机行为的集成测试
- Lua 脚本兼容性测试套件
- 性能回归测试
- 内存安全和泄漏检测
- 红-绿-重构循环严格执行

## 开发约束

### 技术栈要求
**标准化技术选择** 确保项目一致性和可维护性。
- C++17 作为最低标准，C++20 特性可选
- CMake 作为构建系统
- Catch2 或 Google Test 作为测试框架
- Clang-format 统一代码格式
- 静态分析工具集成（Clang-tidy, PVS-Studio等）
- 跨平台兼容性（Windows, Linux, macOS）

### 代码质量标准
**企业级代码质量** 保证长期可维护性。
- 代码覆盖率不低于90%
- 零警告编译（最严格警告级别）
- 静态分析工具零缺陷
- 内存安全工具验证（Valgrind, AddressSanitizer）
- 文档覆盖率要求（所有公共API）
- 代码审查必须通过

### 性能基准
**明确性能目标** 与持续监控。
- 不低于原始Lua 5.1.5的执行性能
- 内存使用不超过参考实现的120%
- 启动时间优化目标
- 关键路径性能基准测试
- 持续集成中的性能回归检测

## 参考项目集成准则

### 参考项目价值定位
**双重技术保障** 确保实现质量和兼容性。

#### lua_c_analysis 项目（技术理解基础）
- **原理理解**：深度分析Lua 5.1.5的实现机制和设计思想
- **详细注释**：提供完整的中文技术解释和实现细节
- **算法解析**：深入解释虚拟机、垃圾回收、表结构等核心算法
- **兼容性参考**：确保行为与官方实现完全一致

#### lua_with_cpp 项目（架构实践参考）
- **现代化架构**：C++17实现的设计模式和最佳实践
- **模块划分**：清晰的组件分离和接口设计
- **错误处理**：现代C++异常和错误处理策略
- **测试架构**：企业级测试框架和质量保证体系

### 参考项目使用策略

#### 技术理解阶段
**lua_c_analysis优先** - 理解原理后设计实现
1. 阅读相关C源码的详细注释和技术解析
2. 理解算法原理和实现细节
3. 分析性能考虑和优化技巧
4. 确保行为兼容性

#### 实现设计阶段
**lua_with_cpp参考** - 现代化架构最佳实践
1. 参考模块化设计和接口定义
2. 借鉴现代C++的使用模式
3. 学习测试架构和质量保证方法
4. 采用成熟的错误处理策略

#### 质量验证原则
**双重验证机制** - 确保实现正确性
- **行为验证**：与lua_c_analysis的原始实现行为对比
- **架构验证**：参考lua_with_cpp的现代化实践
- **性能验证**：不低于原始C实现的性能水平
- **兼容性验证**：通过官方测试套件

### 参考集成工作流程
**系统性参考过程** 确保有效利用参考项目
1. **需求分析**：确定要实现的功能模块
2. **理论研习**：深入研读lua_c_analysis中的相关实现和注释
3. **架构参考**：查阅lua_with_cpp中的对应模块设计
4. **设计决策**：结合两个项目的经验制定实现策略
5. **实现验证**：使用参考项目验证实现正确性

## 开发工作流程

### 规格驱动开发流程
**结构化开发过程** 结合参考项目确保质量和进度。
1. **需求规格化** - 详细的功能规格文档
2. **参考项目研究** - 深入分析lua_c_analysis和lua_with_cpp的相关实现
3. **架构设计** - 基于参考项目经验的技术实现方案和设计决策
4. **任务分解** - 包含参考项目验证步骤的可执行开发任务列表
5. **契约测试** - 基于参考项目行为的TDD测试编写
6. **实现开发** - 参考lua_with_cpp架构的现代C++实现
7. **参考验证** - 与lua_c_analysis行为对比，确保兼容性
8. **集成测试** - 全系统功能和性能验证

### 质量保证流程
**多层次质量验证** 基于参考项目的质量标准。
- **代码审查**：参考lua_with_cpp的代码质量标准
- **行为验证**：与lua_c_analysis的原始行为严格对比
- **性能测试**：不低于lua_c_analysis的性能水准
- **兼容性测试**：使用官方测试套件验证Lua 5.1.5兼容性
- **架构评估**：确保符合现代C++最佳实践

## 项目约束与边界

### 参考项目依赖性管理
**合理利用但不过度依赖** 参考项目资源。
- 禁止直接复制粘贴参考项目代码
- 理解原理后进行独立实现
- 保持架构设计的独立性和创新性
- 在参考基础上进行现代化改进

### 版本管理
**记录参考项目的影响** 和实现决策。
- 文档化从参考项目学到的关键技术点
- 记录重要的架构设计决策和原因
- 维护与参考项目的差异对比
- 建立回溯机制以验证实现正确性

### 代码审查要求
**多层次质量保证** 机制。
- 所有代码变更必须经过同行审查
- 架构变更需要技术负责人批准
- 性能相关变更需要基准测试报告
- 安全敏感变更需要安全审查
- 文档更新与代码变更同步

### 版本控制策略
**清晰的版本管理** 和发布流程。
- 语义化版本号（MAJOR.MINOR.PATCH）
- 功能分支开发模式
- 主分支始终保持可发布状态
- 标签化里程碑版本
- 变更日志详细记录

## 项目治理

### 宪法权威性
**本宪法为项目最高指导原则**，凌驾于所有其他开发实践。
- 所有代码审查必须验证宪法合规性
- 复杂性必须有充分的技术理由
- 偏离宪法原则需要正式批准流程

### 修订程序
**宪法修订的正式流程**。
- 修订提案必须包含详细理由和影响评估
- 需要项目核心团队一致同意
- 修订后需要制定迁移计划
- 版本号更新和修订日期记录

### 争议解决
**技术决策争议的解决机制**。
- 优先参考宪法原则
- 技术决策基于客观证据
- 性能数据优于主观判断
- 兼容性要求优先于便利性

**版本**: 1.1.0 | **制定日期**: 2025-09-20 | **最后修订**: 2025-09-20

---

*本宪法是lua_cpp项目的最高指导原则，所有开发活动必须严格遵循这些规定。修订本宪法需要遵循正式程序，确保项目治理的连续性和稳定性。*